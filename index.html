<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnyHelp? ‚Äì Hyperlocal Tasks</title>
  <meta name="description" content="Find real neighbours to help with quick tasks near you. Post tasks, match fast, and get it done today." />
  <link rel="preconnect" href="https://api.mapbox.com" />
  <style>
    :root{
      --brand:#0a7aff; --brand-2:#6aa9ff;
      --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb; --card:#ffffff;
      --ok:#16a34a; --warn:#d97706; --danger:#ef4444;
      --shadow:0 10px 25px rgba(17,24,39,.06),0 2px 6px rgba(17,24,39,.05);
      --radius:14px;
    }
    /* Dark theme variables */
    body[data-theme="dark"]{
      --ink:#e5ecff; --muted:#93a1bd; --bg:#0b1220; --card:rgba(17,24,39,.78);
      --brand:#5ea1ff; --brand-2:#98c1ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--ink);
      /* TEMP background (we'll swap later to your preferred one) */
      background:
        linear-gradient(180deg,rgba(10,122,255,.10),rgba(10,122,255,0)),
        radial-gradient(900px 360px at 12% -10%, #eaf2ff66, transparent),
        url('https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?q=80&w=2200&auto=format&fit=crop') center/cover fixed;
    }
    body[data-theme="dark"]{
      background:
        linear-gradient(180deg,rgba(10,122,255,.05),rgba(10,122,255,0)),
        radial-gradient(900px 360px at 12% -10%, rgba(94,161,255,.18), transparent),
        url('https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?q=80&w=2200&auto=format&fit=crop') center/cover fixed;
      backdrop-filter:saturate(110%);
    }

    /* App shell */
    header.app{position:sticky;top:0;z-index:50;background:linear-gradient(90deg,var(--brand),#3b82f6);color:#fff}
    body[data-theme="dark"] header.app{background:linear-gradient(90deg,#1f3b7a,#2c4fa9)}
    .nav{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:12px 16px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
    .logo i{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:10px;background:#fff1;border:1px solid #ffffff33}
    .nav a{color:#fff;text-decoration:none;padding:8px 10px;border-radius:10px}
    .nav a.active{background:#ffffff1f}
    .nav-right{margin-left:auto;display:flex;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:0;border-radius:12px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    .btn.secondary{background:#fff;color:var(--brand)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid #ffffff55;box-shadow:none}
    body[data-theme="dark"] .btn.secondary{background:#e6eeff;color:#0b2a6b}

    main{max-width:1100px;margin:0 auto;padding:18px}

    /* Hero */
    .hero{
      position:relative;
      margin-top:18px;
      background:linear-gradient(180deg,var(--card), #f7faff);
      border-radius:20px;padding:28px;box-shadow:var(--shadow);
      display:grid;grid-template-columns:1.15fr .85fr;gap:24px;overflow:hidden
    }
    body[data-theme="dark"] .hero{background:linear-gradient(180deg,var(--card), #0f172a)}
    .hero h1{margin:0 0 8px 0;font-size:clamp(26px,4vw,36px)}
    .hero p{margin:0 0 18px 0;color:var(--muted)}
    .hero .cta{display:flex;gap:10px;flex-wrap:wrap}
    .statgrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:12px}
    .stat{background:rgba(255,255,255,.92);border:1px solid #eef1f7;border-radius:12px;padding:10px;text-align:center}
    body[data-theme="dark"] .stat{background:rgba(17,24,39,.7);border-color:#1f2a44}
    .stat b{font-size:20px}

    .card{background:rgba(255,255,255,.88);backdrop-filter: blur(6px);border:1px solid #eef1f7;border-radius:var(--radius);box-shadow:var(--shadow)}
    body[data-theme="dark"] .card{background:var(--card);border-color:#1f2a44}
    .section{margin:18px 0;padding:18px}

    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{display:grid;gap:12px;grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid-1{display:grid;gap:12px}
    @media (max-width: 860px){.hero{grid-template-columns:1fr}.grid,.grid-3{grid-template-columns:1fr}}

    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-size:16px}
    textarea{min-height:110px}
    input:focus,select:focus,textarea:focus{outline:2px solid #dbeafe;border-color:#bfdbfe}

    .subtitle{margin:0 0 12px;font-weight:800}
    .muted{color:var(--muted)}

    /* Task list */
    ul.cards{list-style:none;padding:0;margin:0;display:grid;gap:12px}
    .task{padding:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;gap:6px;align-items:center;background:#eef6ff;color:#0b62d6;border-radius:999px;padding:3px 8px;font-size:12px}
    .price{font-weight:800}
    body[data-theme="dark"] .badge{background:#17325f;color:#a9c7ff}

    /* Segmented control */
    .seg{display:inline-flex;background:#eaf2ff;border:1px solid #cfe0ff;border-radius:999px;overflow:hidden}
    .seg button{background:transparent;border:0;padding:8px 14px;color:#0b62d6;cursor:pointer}
    .seg button.active{background:#fff;color:var(--brand);font-weight:800}
    body[data-theme="dark"] .seg{background:#0e2a57;border-color:#254a8a}
    body[data-theme="dark"] .seg button{color:#cfe0ff}
    body[data-theme="dark"] .seg button.active{background:#17325f}

    .footer{color:var(--muted);text-align:center;padding:36px 8px}

    /* Router pages (hidden by default) */
    .page{display:none}
    .page.active{display:block}

    /* Toast & modal */
    .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .2s}
    .toast.show{opacity:1}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
    .modal{max-width:680px;width:100%;background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    body[data-theme="dark"] .modal{border-color:#1f2a44}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .modal header h3{margin:0}
    .modal .close{background:transparent;border:0;font-size:22px;cursor:pointer}

    /* Hero media ‚Äì single, tasteful image (dog), scaled down */
    .hero-media{position:relative;min-height:320px}
    .hero-media .photo{
      position:absolute; right:0; top:8px; bottom:8px; width:min(420px, 42vw);
      background-image:url('https://images.unsplash.com/photo-1517849845537-4d257902454a?q=80&w=1600&auto=format&fit=crop');
      background-size:cover;background-position:center;
      border-radius:22px;box-shadow:var(--shadow); overflow:hidden;
      transform:translateX(8px);
    }
    .hero-media .photo::after{
      content:''; position:absolute; inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,.08),rgba(0,0,0,.12));
      pointer-events:none;
    }
    /* let hero text overlap slightly */
    .hero .hero-copy{position:relative; z-index:2}
    .hero .hero-copy .overlap-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; background:#eef6ff; color:#0b62d6; font-weight:700; font-size:13px;
      box-shadow:var(--shadow); transform:translateY(4px);
    }
    body[data-theme="dark"] .hero .hero-copy .overlap-pill{background:#17325f;color:#a9c7ff}

    /* Profile summary card */
    .profile-summary{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:rgba(255,255,255,.6)}
    body[data-theme="dark"] .profile-summary{background:rgba(17,24,39,.5);border-color:#1f2a44}
    .avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#a5b4fc,#93c5fd);display:flex;align-items:center;justify-content:center;color:#0b2a6b;font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#eef6ff;color:#0b62d6;font-size:12px}
    body[data-theme="dark"] .pill{background:#17325f;color:#a9c7ff}
  </style>
</head>
<body>
  <header class="app">
    <nav class="nav">
      <div class="logo"><i>ü§ù</i><span>AnyHelp?</span></div>
      <a href="#/home" id="nav-home" class="active">Home</a>
      <a href="#/tasks" id="nav-tasks">Tasks</a>
      <a href="#/profile" id="nav-profile">Profile</a>
      <a href="#/about" id="nav-about">About</a>
      <div class="nav-right">
        <button class="btn secondary" id="btn-post-cta">Post a task</button>
        <a class="btn ghost" href="#/verify">Get verified</a>
        <button class="btn ghost" id="themeToggle" aria-pressed="false" title="Toggle dark mode">üåô</button>
      </div>
    </nav>
  </header>

  <main>
    <!-- HERO -->
    <section class="hero card page active" id="page-home">
      <div class="hero-copy">
        <span class="overlap-pill">‚ö° Help in minutes</span>
        <h1>Real neighbours, real help, right now</h1>
        <p class="muted">Post a quick task or borrow a tool and get matched with someone nearby in minutes. Start with small, pre-priced jobs that fit student life and city living.</p>
        <div class="cta">
          <button class="btn" id="hero-post">Post a task</button>
          <a class="btn secondary" href="#/tasks">Find tasks near me</a>
        </div>
        <div class="statgrid">
          <div class="stat"><b id="stat-users">0</b><div class="muted">neighbours here</div></div>
          <div class="stat"><b id="stat-completed">0</b><div class="muted">tasks completed</div></div>
          <div class="stat"><b id="stat-eta">&lt;10m</b><div class="muted">typical match time</div></div>
        </div>
      </div>

      <aside class="hero-media" aria-hidden="true">
        <div class="photo" role="img" aria-label="Student walking dogs in the neighbourhood"></div>
      </aside>
    </section>

    <!-- TASKS PAGE -->
    <section class="card section page" id="page-tasks">
      <h2 class="subtitle">Find Tasks</h2>
      <div class="grid">
        <input type="search" id="q" placeholder="Search title or description" />
        <select id="filterCategory">
          <option value="">All categories</option>
          <option>Moving and lifting</option>
          <option>Repairs and DIY</option>
          <option>Gardening</option>
          <option>Errands</option>
          <option>Tool lending</option>
          <option>Pet help</option>
        </select>
        <select id="sortBy">
          <option value="recent">Most recent</option>
          <option value="nearest">Nearest</option>
          <option value="priceHigh">Price, high to low</option>
          <option value="priceLow">Price, low to high</option>
          <option value="trust">Trust first</option>
        </select>
        <input id="myPostcode" placeholder="Your postcode for distance"/>
        <button class="btn" id="locateBtn">Use my location</button>
      </div>
      <div class="muted" id="geoStatus" style="margin:6px 0 12px">Geocoding cache: 0 postcodes</div>
      <ul id="tasks" class="cards"></ul>
    </section>

    <!-- PROFILE PAGE -->
    <section class="card section page" id="page-profile">
      <h2 class="subtitle">Your Profile</h2>
      <div class="row" style="margin-bottom:10px">
        <div class="seg" id="role_seg">
          <button type="button" data-role="poster" class="active">I hire helpers</button>
          <button type="button" data-role="helper">I help neighbours</button>
        </div>
      </div>

      <!-- Poster form -->
      <div id="poster_form" class="grid">
        <input id="p_name" placeholder="Your name"/>
        <input id="p_email" placeholder="email (for notifications)"/>
        <input id="p_pc" placeholder="Home postcode (e.g., SA1 6ET)"/>
        <input id="p_prefcats" placeholder="Preferred categories (comma separated)"/>
        <textarea id="p_notes" class="grid-1" placeholder="Notes for helpers (e.g., buzzer instructions)"></textarea>
      </div>

      <!-- Helper form -->
      <div id="helper_form" class="grid" style="display:none">
        <input id="h_name" placeholder="Your name"/>
        <input id="h_email" placeholder="email (for matches)"/>
        <div class="row"><input type="checkbox" id="h_uni_verified"/> <span class="muted">University email verified</span></div>
        <input id="h_skills" placeholder="Skills (lifting, drill, tech setup)"/>
        <input id="h_rate" placeholder="Typical rate (¬£/hour or flat)"/>
        <input id="h_avail" placeholder="Availability (e.g., evenings & weekends)"/>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="btn" id="save_profile">Save profile</button>
        <button class="btn secondary" id="clear_profile">Clear</button>
      </div>

      <div class="hr"></div>
      <div class="profile-summary" id="profile_summary" style="display:none">
        <div class="avatar" id="profile_avatar">AH</div>
        <div>
          <div style="font-weight:800" id="profile_title">‚Äî</div>
          <div class="muted" id="profile_sub">‚Äî</div>
          <div class="row" id="profile_badges" style="margin-top:6px;gap:6px"></div>
        </div>
      </div>

      <h3 class="subtitle" style="margin-top:14px">My posted tasks</h3>
      <ul id="my_tasks" class="cards"></ul>

      <p class="muted" style="margin-top:8px">Profiles are stored locally in this MVP. When we add verification and payments, you‚Äôll be able to sync securely.</p>
    </section>

    <!-- ABOUT PAGE -->
    <section class="card section page" id="page-about">
      <h2 class="subtitle">About AnyHelp</h2>
      <p>AnyHelp connects neighbours for tiny, everyday tasks, walking dogs, pet sitting, carrying a sofa, borrowing a drill, quick tech setup, matched in minutes, not days. We start in dense student and city areas so you can find help fast. Safety and simplicity are the core: transparent pricing, optional verification badges, and handover codes for item lending.</p>
      <div class="grid-3" style="margin-top:12px">
        <div class="card section">
          <h3 class="subtitle">How it works</h3>
          <ol>
            <li>Post a quick task (or search nearby).</li>
            <li>Nearest available helper accepts.</li>
            <li>Meet, do the thing, confirm completion.</li>
          </ol>
        </div>
        <div class="card section">
          <h3 class="subtitle">Safety basics</h3>
          <ul>
            <li>Meet in public for first jobs.</li>
            <li>Don‚Äôt share sensitive info in posts.</li>
            <li>Use handover codes for lending.</li>
            <li>Only do tasks you‚Äôre comfortable with.</li>
          </ul>
        </div>
        <div class="card section">
          <h3 class="subtitle">What‚Äôs next</h3>
          <ul>
            <li>Optional background checks for badges.</li>
            <li>Stripe payments and ¬£1k limited guarantee.</li>
            <li>Live map view with arrival ETA.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- VERIFY PAGE (placeholder) -->
    <section class="card section page" id="page-verify">
      <h2 class="subtitle">Get Verified</h2>
      <p class="muted">Verification increases trust and match rate. For MVP we support a simple email badge:</p>
      <div class="kv">
        <label>University email</label>
        <input id="v_email" placeholder="you@youruni.ac.uk" />
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="v_send">Send verification link</button>
        <button class="btn secondary" id="v_mark">Mark as verified (demo)</button>
      </div>
      <p class="muted" style="margin-top:10px">In production, this would send an email with a sign-in link. For now, the demo button toggles your badge locally.</p>
    </section>

    <div class="footer">¬© AnyHelp? ‚Äì Community powered ‚Ä¢ Please use this service safely and responsibly ‚Ä¢ Get verified for better matches</div>
  </main>

  <!-- ========= GLOBAL POST TASK MODAL ========= -->
  <div class="modal-backdrop" id="post_modal_backdrop" role="dialog" aria-modal="true" aria-labelledby="post_modal_title">
    <div class="modal">
      <header>
        <h3 id="post_modal_title">Post a Task</h3>
        <button class="close" id="post_modal_close" aria-label="Close">√ó</button>
      </header>
      <div class="grid">
        <input id="m_taskTitle" placeholder="Task title (e.g., Carry a sofa upstairs)"/>
        <select id="m_taskCategory">
          <option value="">Category</option>
          <option>Moving and lifting</option>
          <option>Repairs and DIY</option>
          <option>Gardening</option>
          <option>Errands</option>
          <option>Tool lending</option>
          <option>Pet help</option>
        </select>
        <textarea id="m_taskDescription" placeholder="Describe the task‚Ä¶" class="grid-1"></textarea>
        <input id="m_taskPostcode" placeholder="Postcode, e.g., SA1 6ET"/>
        <input type="number" id="m_taskPrice" placeholder="Offer ¬£" min="0" step="1"/>
        <input type="datetime-local" id="m_taskWhen"/>
        <label class="row"><input type="checkbox" id="m_needsVerified"/> Prefer verified neighbours only</label>

        <div class="grid-1">
          <label class="muted" for="m_payMethod">Payment method</label>
          <select id="m_payMethod">
            <option value="cash">Cash / bank transfer</option>
            <option value="stripe">Stripe payment link</option>
          </select>
        </div>
        <input id="m_stripeLink" placeholder="Stripe Payment Link URL (optional)" />
        <button id="m_postBtn" class="btn">Post Task</button>
      </div>
      <p class="muted" style="margin-top:10px">Tip: You can generate a Stripe Payment Link in your Stripe dashboard and paste it here for this task.</p>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ========= CONFIG =========
    const MAPBOX_TOKEN = "pk.eyJ1IjoiamFrZXJtMTk5NSIsImEiOiJjbWU2c212c3QwMDhpMmpwcWxqaGNnaGx6In0.Am63pVg3I58rTx5ubWzP1Q";

    // ========= Helpers =========
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>[...document.querySelectorAll(s)];
    const LS_TASKS = 'anyhelp.tasks.v2';
    const LS_GEO = 'anyhelp.geo.v2';
    const LS_PROFILE = 'anyhelp.profile.v1';
    const THEME_KEY = 'ah.theme';

    const toastEl = $('#toast');
    function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 2000); }
    function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
    function normPC(pc){ return (pc||'').toUpperCase().replace(/\s+/g,'').trim(); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
    function firstInitials(name){ return (name||'A H').split(/\s+/).slice(0,2).map(x=>x[0]||'').join('').toUpperCase() || 'AH'; }

    // Haversine
    function distanceKm(a,b){ if(!a||!b) return Infinity; const R=6371,toRad=x=>x*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon); const lat1=toRad(a.lat), lat2=toRad(b.lat); const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }

    // ========= Storage =========
    let tasks = []; try{ tasks = JSON.parse(localStorage.getItem(LS_TASKS)) || []; }catch{}
    let GEO_CACHE = {}; try{ GEO_CACHE = JSON.parse(localStorage.getItem(LS_GEO)) || {}; }catch{}
    let profile = {}; try{ profile = JSON.parse(localStorage.getItem(LS_PROFILE)) || {}; }catch{}

    function saveTasks(){ localStorage.setItem(LS_TASKS, JSON.stringify(tasks)); }
    function saveGeo(){ localStorage.setItem(LS_GEO, JSON.stringify(GEO_CACHE)); updateGeoStatus(); }
    function saveProfile(){ localStorage.setItem(LS_PROFILE, JSON.stringify(profile)); }

    function updateGeoStatus(){ const n = Object.keys(GEO_CACHE).length; const el = $('#geoStatus'); if(el) el.textContent = `Geocoding cache: ${n} postcodes`; }

    // ========= Theme (Dark/Light) =========
    function setTheme(t){
      document.body.dataset.theme = t;
      localStorage.setItem(THEME_KEY, t);
      const btn = $('#themeToggle');
      if(btn){ btn.setAttribute('aria-pressed', t==='dark' ? 'true' : 'false'); btn.textContent = (t==='dark' ? '‚òÄÔ∏è' : 'üåô'); }
    }
    function initTheme(){
      const stored = localStorage.getItem(THEME_KEY);
      const prefers = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      setTheme(stored || prefers);
    }

    // ========= Mapbox Geocoding =========
    async function geocodePostcode(pc){ const key = normPC(pc); if(!key) return null; if(GEO_CACHE[key]) return GEO_CACHE[key];
      const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(key)}.json?country=GB&types=postcode&limit=1&access_token=${MAPBOX_TOKEN}`;
      try{ const res = await fetch(url); if(!res.ok) throw new Error('geocode failed'); const data = await res.json(); const f = data.features?.[0]; if(!f || !Array.isArray(f.center)) return null; const [lon,lat] = f.center; const loc = {lat,lon}; GEO_CACHE[key]=loc; saveGeo(); return loc; } catch(e){ console.warn('Geocode error', e); return null; }
    }

    // ========= Post Task (modal) =========
    function openPostModal(){
      $('#post_modal_backdrop').style.display = 'flex';
      // prefill from profile where sensible
      $('#m_taskPostcode').value = profile.p_pc || '';
    }
    function closePostModal(){ $('#post_modal_backdrop').style.display = 'none'; }

    function postTaskFromModal(){
      const title = $('#m_taskTitle').value.trim();
      const description = $('#m_taskDescription').value.trim();
      const category = $('#m_taskCategory').value;
      const postcode = normPC($('#m_taskPostcode').value);
      const price = Number($('#m_taskPrice').value);
      const when = $('#m_taskWhen').value || null;
      const preferVerified = $('#m_needsVerified').checked;
      const payMethod = $('#m_payMethod').value;
      const stripeLink = ($('#m_stripeLink').value || '').trim();

      if(!title || !description || !postcode){ toast('Please fill title, description & postcode'); return; }
      if(Number.isNaN(price) || price < 0){ toast('Enter a valid price (‚â• ¬£0)'); return; }
      if(payMethod==='stripe' && stripeLink && !/^https?:\/\//i.test(stripeLink)){ toast('Stripe link must start with http(s)'); return; }

      const t = {
        id:uid(), title, description, category, postcode, price, when, preferVerified,
        createdAt:Date.now(), status:'open',
        poster:{ name:(profile.p_name||'Neighbour'), email:(profile.p_email||''), verified: !!profile.h_uni_verified, neighbourVerified:false },
        payment:{ method: payMethod, link: stripeLink || '' }
      };
      tasks.unshift(t); saveTasks();
      closePostModal();
      toast('Task posted');
      location.hash = '#/tasks';
      displayTasks();
      bumpStats();
      // clear modal form
      ['#m_taskTitle','#m_taskDescription','#m_taskCategory','#m_taskPostcode','#m_taskPrice','#m_taskWhen','#m_stripeLink'].forEach(sel=>{ const el=$(sel); if(!el) return; el.value=''; });
      $('#m_needsVerified').checked=false; $('#m_payMethod').value='cash';
    }

    // ========= Trust score (demo) =========
    function trustScore(t){ let s=0; if(t.poster?.verified) s+=1; if(t.poster?.neighbourVerified) s+=2; if(t.preferVerified) s+=0.5; return s; }

    // ========= Render task list =========
    let myLocation = null; // {lat,lon}
    async function displayTasks(){
      const ul = $('#tasks'); if(!ul) return; ul.innerHTML = `<li class="card task"><em>Loading‚Ä¶</em></li>`;
      let my = null; if(myLocation) my = myLocation; else { const pc = normPC($('#myPostcode')?.value); if(pc) my = await geocodePostcode(pc); }
      const uniq = [...new Set(tasks.map(t=>normPC(t.postcode)))];
      const coords = {}; await Promise.all(uniq.map(async pc=>{ const loc = await geocodePostcode(pc); if(loc) coords[pc]=loc; }));
      const items = tasks.filter(t=>t.status==='open').map(t=>{
        const there = coords[normPC(t.postcode)] || null;
        const dist = my && there ? distanceKm(my,there) : Infinity;
        return {...t, _dist:dist, _trust:trustScore(t)}
      });
      const q = ($('#q')?.value||'').trim().toLowerCase(); const cat = $('#filterCategory')?.value||''; const sortBy = $('#sortBy')?.value||'recent';
      let out = items; if(q) out = out.filter(t=> (t.title+" "+t.description).toLowerCase().includes(q)); if(cat) out = out.filter(t=> t.category===cat);
      switch(sortBy){
        case 'nearest': out.sort((a,b)=>a._dist-b._dist); break;
        case 'priceHigh': out.sort((a,b)=>b.price-a.price); break;
        case 'priceLow': out.sort((a,b)=>a.price-b.price); break;
        case 'trust': out.sort((a,b)=> (b._trust-a._trust) || (a._dist-b._dist)); break;
        default: out.sort((a,b)=>b.createdAt-a.createdAt);
      }
      if(!out.length){ ul.innerHTML = `<li class="card task"><em>No tasks yet, be the first to post</em></li>`; return; }
      ul.innerHTML='';
      for(const t of out){
        const distStr = isFinite(t._dist) ? `${t._dist.toFixed(1)} km away` : 'distance unknown';
        const whenStr = t.when ? new Date(t.when).toLocaleString() : 'Flexible';
        const badges = [];
        if(t.poster?.verified) badges.push('<span class="badge">Uni verified</span>');
        if(t.poster?.neighbourVerified) badges.push('<span class="badge">Neighbour verified</span>');
        if(t.preferVerified) badges.push('<span class="badge">Prefers verified</span>');
        const payBadge = t.payment?.method==='stripe' ? '<span class="badge">Stripe</span>' : '<span class="badge">Cash/Bank</span>';

        const li = document.createElement('li'); li.className='card task';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:800">${escapeHtml(t.title)}</div>
            <div class="price">¬£${Number.isFinite(t.price)? t.price: '‚Äî'}</div>
          </div>
          <div class="muted">${escapeHtml(t.description)}</div>
          <div class="row" style="margin-top:6px">
            <span class="badge">${t.category||'General'}</span>
            <span class="muted">${t.postcode}</span>
            <span class="muted">${distStr}</span>
            <span class="muted">When: ${whenStr}</span>
            ${badges.join(' ')}
            ${payBadge}
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" data-id="${t.id}" data-act="accept">I can help</button>
            <button class="btn secondary" data-id="${t.id}" data-act="share">Share</button>
            ${t.payment?.method==='stripe' && t.payment?.link ? `<a class="btn secondary" href="${escapeHtml(t.payment.link)}" target="_blank" rel="noopener" data-id="${t.id}" data-act="pay">Pay now</a>` : ''}
            <button class="btn secondary" data-id="${t.id}" data-act="done">Mark complete</button>
          </div>`;
        ul.appendChild(li);
      }
      $('#tasks').onclick = (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act; const t = tasks.find(x=>x.id===id); if(!t) return;
        if(act==='accept'){ toast('In MVP this would open chat / request flow'); }
        if(act==='share'){ const text = `AnyHelp? ‚Ä¢ ${t.title} (${t.postcode}) ‚Äì ${t.description}`; if(navigator.share) navigator.share({title:'AnyHelp?',text}); else { navigator.clipboard.writeText(text); toast('Task copied'); } }
        if(act==='done'){ const code = prompt('Enter the 4-digit handover code to complete'); if(!code || !/^\\d{4}$/.test(code)) return toast('Invalid code'); t.status='done'; saveTasks(); displayTasks(); toast('Completed'); }
      }
      // Also refresh "My posted tasks" if on profile
      renderMyTasks();
    }

    // ========= Geolocation =========
    $('#locateBtn')?.addEventListener('click',()=>{
      if(!navigator.geolocation) return toast('Geolocation not available');
      navigator.geolocation.getCurrentPosition(
        pos=>{ myLocation = {lat:pos.coords.latitude, lon:pos.coords.longitude}; displayTasks(); toast('Location set'); },
        ()=>toast('Could not get your location')
      );
    });

    // ========= Stats (fake counters for social proof) =========
    function bumpStats(){ const a = Number(localStorage.getItem('ah.stat.completed')||'0')+1; localStorage.setItem('ah.stat.completed', a); renderStats(); }
    function renderStats(){ $('#stat-users').textContent = String(Math.max(12, (localStorage.getItem('ah.stat.users')||25))); $('#stat-completed').textContent = String(localStorage.getItem('ah.stat.completed')||0); }

    // ========= Profile =========
    let currentRole = 'poster';
    function setRoleUI(r){
      currentRole = r;
      const pf = $('#poster_form'); const hf = $('#helper_form');
      if(pf&&hf){ pf.style.display = r==='poster' ? '' : 'none'; hf.style.display = r==='helper' ? '' : 'none'; }
      $$('#role_seg button').forEach(b=> b.classList.toggle('active', b.dataset.role===r));
    }
    function loadProfileUI(){
      const r = profile.role||'poster';
      setRoleUI(r);
      // Poster fields
      $('#p_name') && ($('#p_name').value = profile.p_name||'');
      $('#p_email') && ($('#p_email').value = profile.p_email||'');
      $('#p_pc') && ($('#p_pc').value = profile.p_pc||'');
      $('#p_prefcats') && ($('#p_prefcats').value = profile.p_prefcats||'');
      $('#p_notes') && ($('#p_notes').value = profile.p_notes||'');
      // Helper fields
      $('#h_name') && ($('#h_name').value = profile.h_name||'');
      $('#h_email') && ($('#h_email').value = profile.h_email||'');
      $('#h_uni_verified') && ($('#h_uni_verified').checked = !!profile.h_uni_verified);
      $('#h_skills') && ($('#h_skills').value = profile.h_skills||'');
      $('#h_rate') && ($('#h_rate').value = profile.h_rate||'');
      $('#h_avail') && ($('#h_avail').value = profile.h_avail||'');
      renderProfileSummary();
      renderMyTasks();
    }
    function saveProfileUI(){
      const role = currentRole || 'poster';
      profile.role = role;
      // Poster
      profile.p_name = $('#p_name')?.value.trim() || '';
      profile.p_email = $('#p_email')?.value.trim() || '';
      profile.p_pc = $('#p_pc')?.value.trim() || '';
      profile.p_prefcats = $('#p_prefcats')?.value.trim() || '';
      profile.p_notes = $('#p_notes')?.value.trim() || '';
      // Helper
      profile.h_name = $('#h_name')?.value.trim() || '';
      profile.h_email = $('#h_email')?.value.trim() || '';
      profile.h_uni_verified = $('#h_uni_verified')?.checked || false;
      profile.h_skills = $('#h_skills')?.value.trim() || '';
      profile.h_rate = $('#h_rate')?.value.trim() || '';
      profile.h_avail = $('#h_avail')?.value.trim() || '';
      saveProfile(); toast('Profile saved');
      renderProfileSummary();
      renderMyTasks();
    }
    function renderProfileSummary(){
      const wrap = $('#profile_summary'); if(!wrap) return;
      const name = (profile.p_name || profile.h_name || '').trim();
      const email = (profile.p_email || profile.h_email || '').trim();
      if(!name && !email){ wrap.style.display='none'; return; }
      wrap.style.display='';
      $('#profile_avatar').textContent = firstInitials(name || 'Any Help');
      const roleLabel = profile.role==='helper' ? 'Helper' : 'Poster';
      $('#profile_title').textContent = name ? `${name} ‚Ä¢ ${roleLabel}` : roleLabel;
      $('#profile_sub').textContent = email || '';
      const badges = [];
      if(profile.h_uni_verified) badges.push('<span class="pill">Uni verified</span>');
      if((profile.p_prefcats||'').trim()) badges.push(`<span class="pill">Prefers: ${escapeHtml(profile.p_prefcats)}</span>`);
      if((profile.h_skills||'').trim()) badges.push(`<span class="pill">Skills: ${escapeHtml(profile.h_skills)}</span>`);
      $('#profile_badges').innerHTML = badges.join(' ');
    }
    function renderMyTasks(){
      const ul = $('#my_tasks'); if(!ul) return;
      const myEmail = (profile.p_email||'').trim();
      const mine = myEmail ? tasks.filter(t=> (t.poster?.email||'')===myEmail) : [];
      ul.innerHTML = '';
      if(!mine.length){ ul.innerHTML = '<li class="card task"><em>No posted tasks yet</em></li>'; return; }
      for(const t of mine){
        const li = document.createElement('li'); li.className='card task';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div><strong>${escapeHtml(t.title)}</strong> <span class="muted">(${t.postcode})</span></div>
            <div class="price">¬£${Number.isFinite(t.price)?t.price:'‚Äî'}</div>
          </div>
          <div class="muted">${escapeHtml(t.description)}</div>
          <div class="row" style="margin-top:6px">
            <span class="badge">${t.category||'General'}</span>
            <span class="muted">When: ${t.when ? new Date(t.when).toLocaleString() : 'Flexible'}</span>
            <span class="muted">Status: ${t.status}</span>
            <span class="badge">${t.payment?.method==='stripe'?'Stripe':'Cash/Bank'}</span>
          </div>`;
        ul.appendChild(li);
      }
    }

    // Role switcher
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('#role_seg button');
      if(!b) return; setRoleUI(b.dataset.role);
    });

    // Verify demo
    $('#v_send')?.addEventListener('click', ()=>toast('Verification email would be sent (demo)'));
    $('#v_mark')?.addEventListener('click', ()=>{ profile.h_uni_verified = true; saveProfile(); loadProfileUI(); toast('Marked verified (demo)'); });

    // ========= Theme toggle =========
    $('#themeToggle')?.addEventListener('click', ()=>{
      const next = (document.body.dataset.theme === 'dark') ? 'light' : 'dark';
      setTheme(next);
    });

    // ========= Router =========
    const pages = { home:'#page-home', tasks:'#page-tasks', profile:'#page-profile', about:'#page-about', verify:'#page-verify' };
    function setActiveNav(route){ ['home','tasks','profile','about'].forEach(r=>{ const a = document.querySelector(`#nav-${r}`); if(a) a.classList.toggle('active', r===route); }); }
    function show(route){
      Object.values(pages).forEach(sel=>{ const el = document.querySelector(sel); if(el) el.classList.remove('active'); });
      const el = document.querySelector(pages[route]||pages.home); if(el) el.classList.add('active');
      setActiveNav(route);
      if(route==='tasks') displayTasks();
      if(route==='profile') loadProfileUI();
    }
    function router(){ const hash = location.hash.replace('#/',''); const route = hash in pages ? hash : 'home'; show(route); }
    window.addEventListener('hashchange', router);

    // Bind buttons
    $('#hero-post')?.addEventListener('click', openPostModal);
    $('#btn-post-cta')?.addEventListener('click', openPostModal);
    $('#post_modal_close')?.addEventListener('click', closePostModal);
    $('#post_modal_backdrop')?.addEventListener('click', (e)=>{ if(e.target.id==='post_modal_backdrop') closePostModal(); });
    $('#m_postBtn')?.addEventListener('click', postTaskFromModal);

    $('#save_profile')?.addEventListener('click', saveProfileUI);
    $('#clear_profile')?.addEventListener('click', ()=>{ profile = {}; saveProfile(); loadProfileUI(); toast('Profile cleared'); });

    // Filters events
    ['#q','#filterCategory','#sortBy','#myPostcode'].forEach(sel=>{ const el = document.querySelector(sel); if(el) el.addEventListener('input', displayTasks); });

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      initTheme();
      updateGeoStatus();
      renderStats();
      router();
      displayTasks();
      loadProfileUI();
    });
  </script>
</body>
</html>
